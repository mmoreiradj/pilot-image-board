name: test-ci

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number"
        required: true
        default: "0"

jobs:
  clean-up:
    name: Clean Up
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ inputs.pr_number }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
      - name: Terraform Backend
        working-directory: ./.infra/terraform
        run: |
          echo "$EPHEMERAL_TF_BACKEND" > ${{ runner.temp }}/backend.tf
          echo "key = \"kubernetes/apps/${{ github.repository }}/ephemeral/pr-$PR_NUMBER/terraform.tfstate\"" >> ${{ runner.temp }}/backend.tf
          chmod 200 ${{ runner.temp }}/backend.tf
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"
      - name: Setup Kubeconfig
        run: |
          echo "$KUBECONFIG" > ${{ runner.temp }}/kubeconfig
          chmod 200 ${{ runner.temp }}/kubeconfig
      - name: Terraform Init
        working-directory: ./.infra/terraform/ephemeral
        run: terraform init -backend-config=${{ runner.temp }}/backend.tf
